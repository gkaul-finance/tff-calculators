<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ch 5: NPV & IRR Calculator | The Finance Framework</title>
    <style>
        :root { --maize: #FFCB05; --blue: #00274C; --light-blue: #E6EEF4; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #fff; min-height: 100vh; padding: 20px; }
        .container { max-width: 550px; margin: 0 auto; }
        .header { background-color: var(--blue); color: white; padding: 20px; border-radius: 12px 12px 0 0; text-align: center; }
        .header .chapter { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; }
        .header h1 { font-size: 1.5rem; font-weight: 600; margin-bottom: 8px; }
        .header p { font-size: 0.85rem; opacity: 0.8; }
        .main-content { background-color: var(--light-blue); padding: 20px; border-radius: 0 0 12px 12px; border: 2px solid var(--blue); border-top: none; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 6px; color: var(--blue); font-size: 0.9rem; }
        .input-wrapper { position: relative; }
        .input-wrapper .suffix { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #666; font-weight: 500; }
        input { width: 100%; padding: 12px; font-size: 1rem; border: 2px solid var(--maize); border-radius: 8px; background-color: white; }
        input:focus { outline: none; border-color: var(--blue); }
        input.has-suffix { padding-right: 35px; }
        .cash-flows-section { background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .cash-flows-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .cash-flows-header h3 { color: var(--blue); font-size: 0.95rem; }
        .cash-flows-header button { background-color: var(--maize); color: var(--blue); border: none; padding: 6px 12px; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.85rem; }
        .cash-flow-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .cash-flow-row .period { width: 60px; text-align: center; font-weight: 600; color: var(--blue); font-size: 0.9rem; }
        .cash-flow-row input { flex: 1; border-color: #ddd; }
        .cash-flow-row input.negative { border-color: #dc2626; background-color: #fef2f2; }
        .cash-flow-row input.positive { border-color: #16a34a; background-color: #f0fdf4; }
        .cash-flow-row .remove-btn { background-color: #fee2e2; color: #dc2626; border: none; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .cash-flow-row .remove-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .button-row { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn { padding: 14px; font-size: 1rem; font-weight: 600; border: none; border-radius: 8px; cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; }
        .btn-primary { flex: 2; background-color: var(--maize); color: var(--blue); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,39,76,0.3); }
        .btn-secondary { flex: 1; background-color: white; color: var(--blue); border: 2px solid var(--blue); }
        .error-box { background-color: #fee2e2; color: #dc2626; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9rem; text-align: center; display: none; }
        .decision-banner { padding: 15px; border-radius: 8px; text-align: center; font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; display: none; }
        .decision-banner.accept { background-color: #dcfce7; color: #16a34a; border: 2px solid #16a34a; }
        .decision-banner.reject { background-color: #fee2e2; color: #dc2626; border: 2px solid #dc2626; }
        .results-box { background-color: var(--blue); color: white; padding: 20px; border-radius: 8px; display: none; margin-bottom: 15px; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .result-item { text-align: center; }
        .result-item .label { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; }
        .result-item .value { font-size: 1.5rem; font-weight: 700; color: var(--maize); }
        .result-item .sub { font-size: 0.75rem; opacity: 0.7; margin-top: 3px; }
        .helper-text { padding: 15px; background-color: white; border-radius: 8px; font-size: 0.85rem; color: #666; line-height: 1.5; }
        .helper-text strong { color: var(--blue); }
        .footer { text-align: center; margin-top: 15px; font-size: 0.8rem; color: #999; }
    
        .philosophy-note {
            background: #fffbeb;
            border: 1px solid #f6e05e;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 15px;
            font-size: 0.82rem;
            color: #744210;
            text-align: center;
            line-height: 1.5;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="chapter">Chapter 5</div>
            <h1>NPV & IRR Calculator</h1>
            <p>The Finance Framework</p>
        </div>
        
        <div class="main-content">
            <div class="philosophy-note">
                This calculator is an example of what can be built for a specific numerical problem—not a substitute for understanding. Real financial analysis requires building your own models, because the process of building is where understanding lives. The exercises in the book do not all require this calculator. Many are deliberately conceptual, because finance is ultimately about how you think, not how you calculate.
            </div>
            <div class="form-group">
                <label>Discount Rate (Cost of Capital)</label>
                <div class="input-wrapper">
                    <input type="number" id="discountRate" step="0.1" class="has-suffix" placeholder="e.g., 10">
                    <span class="suffix">%</span>
                </div>
            </div>
            
            <div class="cash-flows-section">
                <div class="cash-flows-header">
                    <h3>Cash Flows</h3>
                    <button onclick="addPeriod()">+ Add Period</button>
                </div>
                <div id="cash-flows-container"></div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-primary" onclick="calculate()">Calculate NPV & IRR</button>
                <button class="btn btn-secondary" onclick="clearAll()">Clear</button>
            </div>
            
            <div class="error-box" id="error"></div>
            <div class="decision-banner" id="decision"></div>
            
            <div class="results-box" id="results">
                <div class="results-grid">
                    <div class="result-item">
                        <div class="label">Net Present Value</div>
                        <div class="value" id="npv-value">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Internal Rate of Return</div>
                        <div class="value" id="irr-value">0%</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Payback Period</div>
                        <div class="value" id="payback-value">N/A</div>
                        <div class="sub">(undiscounted)</div>
                    </div>
                    <div class="result-item">
                        <div class="label">Profitability Index</div>
                        <div class="value" id="pi-value">0</div>
                        <div class="sub">PV(inflows) / |Investment|</div>
                    </div>
                </div>
            </div>
            
            <div class="helper-text">
                <strong>NPV Rule:</strong> Accept if NPV > 0 (project adds value).<br>
                <strong>IRR Rule:</strong> Accept if IRR > Cost of Capital.<br><br>
                <strong>Note:</strong> Enter initial investment as negative (cash outflow). Future inflows should be positive.
            </div>
        </div>
        
        <div class="footer">
            © The Finance Framework — Professor Gautam Kaul<br>
            University of Michigan<br>
            <a href="index.html" style="color: #00274C; margin-top: 8px; display: inline-block;">← All Calculators</a>
        </div>
    </div>
    
    <script>
        let periodCount = 0;
        
        function initializeCashFlows() {
            const container = document.getElementById('cash-flows-container');
            container.innerHTML = '';
            periodCount = 0;
            for (let i = 0; i < 4; i++) addPeriod();
        }
        
        function styleCashFlow(input) {
            const value = parseFloat(input.value);
            input.classList.remove('negative', 'positive');
            if (!isNaN(value)) {
                if (value < 0) input.classList.add('negative');
                else if (value > 0) input.classList.add('positive');
            }
        }
        
        function addPeriod() {
            const container = document.getElementById('cash-flows-container');
            const row = document.createElement('div');
            row.className = 'cash-flow-row';
            row.innerHTML = `
                <span class="period">t = ${periodCount}</span>
                <input type="number" id="cf-${periodCount}" placeholder="${periodCount === 0 ? 'Initial investment (negative)' : 'Cash flow'}" onchange="styleCashFlow(this)">
                <button class="remove-btn" onclick="removePeriod(${periodCount})" ${periodCount === 0 ? 'disabled' : ''}>×</button>
            `;
            container.appendChild(row);
            periodCount++;
        }
        
        function removePeriod(index) {
            const rows = document.querySelectorAll('.cash-flow-row');
            if (rows.length <= 2) return;
            const values = [];
            rows.forEach((row, i) => { if (i !== index) values.push(row.querySelector('input').value); });
            initializeCashFlows();
            const container = document.getElementById('cash-flows-container');
            container.innerHTML = '';
            periodCount = 0;
            values.forEach((val, i) => {
                addPeriod();
                const input = document.getElementById('cf-' + i);
                input.value = val;
                styleCashFlow(input);
            });
        }
        
        function getCashFlows() {
            const cashFlows = [];
            document.querySelectorAll('.cash-flow-row input').forEach(input => {
                cashFlows.push(parseFloat(input.value) || 0);
            });
            return cashFlows;
        }
        
        function calculateNPV(cashFlows, rate) {
            return cashFlows.reduce((npv, cf, t) => npv + cf / Math.pow(1 + rate, t), 0);
        }
        
        function calculateIRR(cashFlows) {
            let rate = 0.1;
            for (let i = 0; i < 1000; i++) {
                let npv = 0, dnpv = 0;
                for (let t = 0; t < cashFlows.length; t++) {
                    npv += cashFlows[t] / Math.pow(1 + rate, t);
                    if (t > 0) dnpv -= t * cashFlows[t] / Math.pow(1 + rate, t + 1);
                }
                if (Math.abs(npv) < 0.0000001) return rate;
                if (Math.abs(dnpv) < 0.0000001) { rate += 0.1; continue; }
                rate = rate - npv / dnpv;
                if (rate < -0.99) rate = -0.99;
                if (rate > 10) rate = 10;
            }
            return null;
        }
        
        function calculatePayback(cashFlows) {
            if (cashFlows[0] >= 0) return null;
            let cumulative = 0;
            for (let t = 0; t < cashFlows.length; t++) {
                cumulative += cashFlows[t];
                if (cumulative >= 0) return (t - 1) + (-1 * (cumulative - cashFlows[t])) / cashFlows[t];
            }
            return null;
        }
        
        function calculate() {
            const discountRate = parseFloat(document.getElementById('discountRate').value) / 100;
            const cashFlows = getCashFlows();
            
            const errorBox = document.getElementById('error');
            const decisionBanner = document.getElementById('decision');
            const resultsBox = document.getElementById('results');
            
            errorBox.style.display = 'none';
            decisionBanner.style.display = 'none';
            resultsBox.style.display = 'none';
            
            try {
                if (isNaN(discountRate)) throw new Error('Please enter a discount rate');
                if (cashFlows.every(cf => cf === 0)) throw new Error('Please enter at least one non-zero cash flow');
                
                const npv = calculateNPV(cashFlows, discountRate);
                const irr = calculateIRR(cashFlows);
                const payback = calculatePayback(cashFlows);
                const investment = Math.abs(cashFlows[0]);
                const pvInflows = cashFlows.slice(1).reduce((pv, cf, t) => pv + cf / Math.pow(1 + discountRate, t + 1), 0);
                const pi = investment > 0 ? pvInflows / investment : 0;
                
                document.getElementById('npv-value').textContent = '$' + npv.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('irr-value').textContent = irr !== null ? (irr * 100).toFixed(2) + '%' : 'N/A';
                document.getElementById('payback-value').textContent = payback !== null ? payback.toFixed(2) + ' periods' : 'Never';
                document.getElementById('pi-value').textContent = pi.toFixed(3);
                
                if (npv > 0) {
                    decisionBanner.textContent = '✓ ACCEPT — NPV is positive, project adds value';
                    decisionBanner.className = 'decision-banner accept';
                } else {
                    decisionBanner.textContent = '✗ REJECT — NPV is negative, project destroys value';
                    decisionBanner.className = 'decision-banner reject';
                }
                
                decisionBanner.style.display = 'block';
                resultsBox.style.display = 'block';
            } catch (err) {
                errorBox.textContent = err.message;
                errorBox.style.display = 'block';
            }
        }
        
        function clearAll() {
            document.getElementById('discountRate').value = '';
            initializeCashFlows();
            document.getElementById('error').style.display = 'none';
            document.getElementById('decision').style.display = 'none';
            document.getElementById('results').style.display = 'none';
        }
        
        initializeCashFlows();
    </script>
</body>
</html>
